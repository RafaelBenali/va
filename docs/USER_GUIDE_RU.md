# TNSE - Telegram News Search Engine
# Руководство пользователя

---

## Содержание

1. [Обзор системы](#1-обзор-системы)
2. [Архитектура и процессы](#2-архитектура-и-процессы)
3. [Сбор данных](#3-сбор-данных)
4. [Команды бота](#4-команды-бота)
5. [Система метрик](#5-система-метрик)
6. [Обработка LLM](#6-обработка-llm)
7. [Доступные данные](#7-доступные-данные)
8. [Сценарии использования](#8-сценарии-использования)
9. [Конфигурация](#9-конфигурация)
10. [Устранение неполадок](#10-устранение-неполадок)

---

## 1. Обзор системы

**TNSE (Telegram News Search Engine)** - это система агрегации и поиска новостей из публичных Telegram-каналов. Основной интерфейс пользователя - Telegram-бот.

### Ключевые возможности

- Мониторинг публичных Telegram-каналов на предмет новостного контента
- Поиск по ключевым словам с полнотекстовым поиском PostgreSQL
- Семантический поиск с помощью LLM-обогащения (опционально)
- Ранжирование результатов по метрикам вовлеченности
- Экспорт результатов поиска в CSV/JSON
- Сохранение поисковых конфигураций как "топиков"

### Технологический стек

| Компонент | Технология |
|-----------|------------|
| Backend | Python 3.12+ с FastAPI |
| База данных | PostgreSQL 14+ |
| Кэш/Очередь | Redis 6+ |
| Очередь задач | Celery с Redis |
| Контейнеризация | Docker, Docker Compose |
| LLM Provider | Groq API (qwen-qwq-32b) |

---

## 2. Архитектура и процессы

### 2.1 Docker-сервисы

Система состоит из следующих Docker-контейнеров:

| Сервис | Контейнер | Описание |
|--------|-----------|----------|
| PostgreSQL | `tnse_postgres` | База данных с поддержкой русского языка |
| Redis | `tnse_redis` | Кэш и брокер сообщений |
| App | `tnse_app` | API-сервер (опционально) |
| Celery Worker | `tnse_celery_worker` | Обработка фоновых задач |
| Celery Beat | `tnse_celery_beat` | Планировщик периодических задач |

### 2.2 Фоновые процессы

#### Celery Beat - Планировщик задач

Celery Beat запускает периодические задачи по расписанию:

| Задача | Интервал | Описание |
|--------|----------|----------|
| `collect_all_channels` | Каждые 15 минут | Сбор контента со всех активных каналов |
| `enrich_new_posts` | Каждые 5 минут | LLM-обогащение новых постов (до 50 за запуск) |

#### Celery Worker - Исполнитель задач

Celery Worker выполняет следующие типы задач:

**Задачи сбора контента:**
- `collect_all_channels` - сбор со всех каналов
- `collect_channel_content` - сбор с конкретного канала

**Задачи LLM-обогащения:**
- `enrich_post` - обогащение одного поста
- `enrich_new_posts` - пакетное обогащение новых постов
- `enrich_channel_posts` - обогащение постов конкретного канала

### 2.3 Telegram Bot

Бот работает в двух режимах:

- **Polling режим** (по умолчанию) - бот постоянно опрашивает Telegram API
- **Webhook режим** - Telegram отправляет обновления на указанный URL

Бот инициализируется с набором сервисов:
- `channel_service` - валидация и управление каналами
- `db_session_factory` - фабрика сессий БД
- `search_service` - поисковый сервис
- `topic_service` - управление сохраненными топиками

### 2.4 Диаграмма потока данных

```
Telegram каналы
       |
       v
[Telegram MTProto API]
       |
       v
[ContentCollector] -----> [ContentStorage]
       |                        |
       v                        v
[MessageInfo]              [PostgreSQL]
                                |
       +------------------------+
       |                        |
       v                        v
[EnrichmentService]      [SearchService]
       |                        |
       v                        v
[Groq LLM API]           [Telegram Bot]
       |                        |
       v                        v
[PostEnrichment]           [User]
```

---

## 3. Сбор данных

### 3.1 Процесс сбора контента

1. **Инициализация**: Celery Beat запускает задачу `collect_all_channels` каждые 15 минут
2. **Получение каналов**: Система загружает все активные каналы из БД
3. **Сбор сообщений**: Для каждого канала:
   - Используется `last_collected_message_id` для получения только новых сообщений
   - Фильтруются сообщения в пределах временного окна (24 часа по умолчанию)
   - Извлекаются: текст, медиа, метрики вовлеченности, информация о пересылке
4. **Сохранение**: Данные сохраняются в соответствующие таблицы БД
5. **Обновление трекера**: `last_collected_message_id` обновляется для каждого канала

### 3.2 Схема базы данных

#### Основные таблицы

| Таблица | Описание |
|---------|----------|
| `channels` | Мониторимые Telegram-каналы |
| `posts` | Посты/сообщения из каналов |
| `post_content` | Текстовое содержимое постов |
| `post_media` | Медиа-вложения постов |
| `engagement_metrics` | Метрики вовлеченности |
| `reaction_counts` | Счетчики реакций по типам эмодзи |
| `channel_health_logs` | Логи состояния здоровья каналов |
| `post_enrichments` | LLM-обогащенные метаданные |
| `llm_usage_logs` | Логи использования LLM API |
| `saved_topics` | Сохраненные поисковые конфигурации |
| `topic_templates` | Предустановленные шаблоны топиков |
| `bot_settings` | Настройки бота (key-value) |

#### Структура таблицы `channels`

```sql
- id: UUID (первичный ключ)
- telegram_id: BIGINT (ID канала в Telegram)
- username: VARCHAR(255) (имя пользователя без @)
- title: VARCHAR(255) (название канала)
- description: TEXT (описание)
- subscriber_count: INTEGER (число подписчиков)
- photo_url: VARCHAR(1024)
- invite_link: VARCHAR(255)
- is_active: BOOLEAN (активен ли мониторинг)
- last_collected_message_id: BIGINT (для resume tracking)
- last_collected_at: TIMESTAMP WITH TZ
- created_at, updated_at: TIMESTAMP WITH TZ
```

#### Структура таблицы `posts`

```sql
- id: UUID (первичный ключ)
- channel_id: UUID (FK -> channels.id)
- telegram_message_id: BIGINT (ID сообщения в Telegram)
- published_at: TIMESTAMP WITH TZ
- is_forwarded: BOOLEAN
- forward_from_channel_id: BIGINT
- forward_from_message_id: BIGINT
- created_at, updated_at: TIMESTAMP WITH TZ
```

#### Структура таблицы `post_enrichments`

```sql
- id: UUID (первичный ключ)
- post_id: UUID (FK -> posts.id, уникальный)
- explicit_keywords: TEXT[] (ключевые слова из текста)
- implicit_keywords: TEXT[] (связанные понятия НЕ из текста)
- category: VARCHAR(100) (politics, economics, technology, etc.)
- sentiment: VARCHAR(20) (positive, negative, neutral)
- entities: JSONB (persons, organizations, locations)
- model_used: VARCHAR(100)
- token_count: INTEGER
- processing_time_ms: INTEGER
- enriched_at: TIMESTAMP WITH TZ
```

### 3.3 Управление каналами

Каналы имеют следующие статусы здоровья:

| Статус | Описание |
|--------|----------|
| `healthy` | Канал доступен и работает нормально |
| `rate_limited` | Превышен лимит запросов к API |
| `inaccessible` | Канал недоступен |
| `removed` | Канал удален |

---

## 4. Команды бота

### 4.1 Базовые команды

| Команда | Алиас | Описание |
|---------|-------|----------|
| `/start` | - | Приветственное сообщение |
| `/help` | `/h` | Справка по командам |
| `/settings` | - | Настройки бота |

### 4.2 Управление каналами

| Команда | Синтаксис | Описание |
|---------|-----------|----------|
| `/addchannel` | `/addchannel @username` | Добавить канал в мониторинг |
| `/removechannel` | `/removechannel @username` | Удалить канал |
| `/channels` | `/ch` | Список мониторимых каналов |
| `/channelinfo` | `/channelinfo @username` | Информация о канале |
| `/import` | `/import` | Импорт каналов из файла (CSV, JSON, TXT) |
| `/health` | `/health` | Статус здоровья всех каналов |
| `/sync` | `/sync` | Принудительная синхронизация контента |

**Примеры:**

```
/addchannel @telegram
/addchannel https://t.me/telegram
/channelinfo @telegram
```

Команда `/addchannel` поддерживает форматы:
- `@username`
- `username`
- `https://t.me/username`
- `https://telegram.me/username`

### 4.3 Поиск

| Команда | Синтаксис | Описание |
|---------|-----------|----------|
| `/search` | `/s <запрос>` | Поиск по ключевым словам |

**Параметры поиска:**

- Базовый поиск: `/search коррупция скандал`
- С фильтром категории: `/search новости category:politics`
- С фильтром тональности: `/search скандал sentiment:negative`
- Комбинированный: `/search экономика category:economics sentiment:positive`

**Доступные категории:**
- `politics` - политика
- `economics` - экономика
- `technology` - технологии
- `sports` - спорт
- `entertainment` - развлечения
- `health` - здоровье
- `military` - военные новости
- `crime` - криминал
- `society` - общество
- `other` - другое

**Доступные значения sentiment:**
- `positive` - позитивная тональность
- `negative` - негативная тональность
- `neutral` - нейтральная тональность

### 4.4 Экспорт

| Команда | Синтаксис | Описание |
|---------|-----------|----------|
| `/export` | `/e [формат]` | Экспорт результатов поиска |

**Форматы:**
- `/export` или `/export csv` - экспорт в CSV
- `/export json` - экспорт в JSON
- `/export help` - справка по экспорту

**Содержимое экспорта:**
- Информация о канале (username, title)
- Превью контента поста
- Количество просмотров и метрики вовлеченности
- Прямые ссылки на оригинальные посты в Telegram

### 4.5 Топики

| Команда | Синтаксис | Описание |
|---------|-----------|----------|
| `/savetopic` | `/savetopic <имя>` | Сохранить текущий поиск как топик |
| `/topics` | `/t` | Список сохраненных топиков |
| `/topic` | `/topic <имя>` | Выполнить сохраненный поиск |
| `/deletetopic` | `/deletetopic <имя>` | Удалить топик |
| `/templates` | `/templates` | Показать предустановленные шаблоны |
| `/usetemplate` | `/usetemplate <имя>` | Использовать шаблон |

**Пример workflow:**

```
1. /search коррупция взятка скандал
2. /savetopic corruption_news
3. /topic corruption_news
```

### 4.6 LLM-команды

| Команда | Синтаксис | Описание |
|---------|-----------|----------|
| `/mode` | `/m [llm|metrics]` | Переключение режима поиска |
| `/enrich` | `/enrich @channel` | Запустить LLM-обогащение канала |
| `/llmstats` | `/llmstats` | Статистика использования LLM |

**Режимы поиска:**

- `metrics` (по умолчанию) - поиск только по метрикам, без LLM
- `llm` - расширенный поиск с категориями, тональностью и неявными ключевыми словами

**Пример:**

```
/mode llm
/search экономика category:economics
```

---

## 5. Система метрик

### 5.1 Собираемые метрики

| Метрика | Описание |
|---------|----------|
| `view_count` | Количество просмотров поста |
| `forward_count` | Количество пересылок |
| `reply_count` | Количество ответов/комментариев |
| `reaction_score` | Взвешенная оценка реакций |
| `relative_engagement` | Вовлеченность относительно подписчиков |

### 5.2 Расчет reaction_score

Формула:
```
reaction_score = SUM(emoji_count * emoji_weight)
```

Веса по умолчанию (настраиваются через переменные окружения):

| Эмодзи | Вес | Переменная |
|--------|-----|------------|
| heart | 2.0 | `REACTION_WEIGHT_HEART` |
| fire | 1.5 | `REACTION_WEIGHT_FIRE` |
| thumbs_up | 1.0 | `REACTION_WEIGHT_THUMBS_UP` |
| clap | 1.0 | `REACTION_WEIGHT_CLAP` |
| thinking | 0.5 | `REACTION_WEIGHT_THINKING` |
| thumbs_down | -1.0 | `REACTION_WEIGHT_THUMBS_DOWN` |
| default | 1.0 | `REACTION_WEIGHT_DEFAULT` |

**Пример:**
```
Реакции: thumbs_up=150, heart=89, fire=34
Score = 150*1.0 + 89*2.0 + 34*1.5 = 379.0
```

### 5.3 Расчет relative_engagement

Формула:
```
relative_engagement = (views + reaction_score) / subscriber_count
```

Эта метрика нормализует вовлеченность относительно размера аудитории канала.

### 5.4 Алгоритм ранжирования

Система поддерживает несколько режимов сортировки:

| Режим | Описание |
|-------|----------|
| `combined` | Комбинированная оценка (вовлеченность * фактор свежести) |
| `views` | По количеству просмотров |
| `reactions` | По reaction_score |
| `engagement` | По relative_engagement |
| `recency` | По времени публикации (новые первыми) |

**Формула combined_score:**
```
recency_factor = max(0, 1 - hours_since_post / time_window_hours)
combined_score = relative_engagement * (1 - recency_weight + recency_factor * recency_weight)
```

### 5.5 Что можно добавить для сбора

Система легко расширяется для сбора дополнительных метрик:

| Метрика | Сложность | Описание |
|---------|-----------|----------|
| Комментарии в группе | Средняя | Требует доступа к связанной группе |
| Репосты с текстом | Средняя | Анализ контекста репостов |
| Время максимальной активности | Низкая | Временные метки пиков просмотров |
| Скорость набора просмотров | Низкая | Динамика views во времени |
| Аудитория пересылок | Высокая | Анализ каналов-получателей |

---

## 6. Обработка LLM

### 6.1 Архитектура обогащения

Система использует подход "RAG без векторов" - вместо векторных эмбеддингов используются массивы ключевых слов, извлеченных LLM.

**Ключевое нововведение:** Implicit keywords (неявные ключевые слова) - связанные понятия, которых НЕТ в тексте, но которые семантически релевантны.

### 6.2 Промпт для обогащения

Система использует следующий промпт (на русском языке):

```
Проанализируй этот пост из Telegram. Извлеки структурированную информацию.

СОДЕРЖАНИЕ ПОСТА:
{text_content}

Верни результат в формате JSON:
{
    "explicit_keywords": ["список ключевых слов/фраз, которые присутствуют непосредственно в тексте"],
    "implicit_keywords": ["список связанных понятий, тем, сущностей, которых НЕТ в тексте, но они семантически релевантны"],
    "category": "основная категория темы (politics, economics, technology, sports, entertainment, health, military, crime, society, other)",
    "sentiment": "positive|negative|neutral",
    "entities": {
        "persons": ["имена упомянутых или подразумеваемых людей"],
        "organizations": ["названия организаций, компаний, учреждений"],
        "locations": ["географические локации"]
    }
}

ВАЖНО для implicit_keywords (неявные ключевые слова):
- Это понятия, которые читатель ассоциирует с контентом, но они НЕ упоминаются напрямую в тексте
- Включай связанные термины, синонимы, более широкие категории, контекстные ассоциации
- Пример: Если пост упоминает "iPhone", неявные ключевые слова могут включать ["Apple", "смартфон", "iOS", "гаджет"]
- Пример: Если пост о "Министр пойман при получении взятки", неявные слова: ["коррупция", "взяточничество", "скандал", "политика"]

ВАЖНО для explicit_keywords (явные ключевые слова):
- Извлекай ключевые слова и фразы, которые фактически присутствуют в тексте
- Фокусируйся на существительных, именах собственных и значимых терминах

КРИТИЧЕСКИ ВАЖНО:
- Все ключевые слова (explicit и implicit) ДОЛЖНЫ быть на русском языке
- Имена собственные оставляй как в оригинале
- Возвращай ТОЛЬКО валидный JSON, без объяснений и дополнительного текста
```

### 6.3 Хранение обогащенных данных

Данные сохраняются в таблицу `post_enrichments`:

| Поле | Тип | Описание |
|------|-----|----------|
| `explicit_keywords` | TEXT[] | Ключевые слова из текста |
| `implicit_keywords` | TEXT[] | Связанные понятия (ключ для RAG) |
| `category` | VARCHAR(100) | Категория контента |
| `sentiment` | VARCHAR(20) | Тональность |
| `entities` | JSONB | Именованные сущности |
| `model_used` | VARCHAR(100) | Использованная модель |
| `token_count` | INTEGER | Использовано токенов |
| `processing_time_ms` | INTEGER | Время обработки |

### 6.4 Расширенный поиск

При включенном LLM-режиме поиск работает по трем измерениям:

1. **Полнотекстовый поиск** - PostgreSQL FTS по `post_content.text_content`
2. **Explicit keywords** - пересечение с массивом `explicit_keywords`
3. **Implicit keywords** - пересечение с массивом `implicit_keywords` (ключевое!)

Поиск по implicit keywords позволяет находить релевантный контент, даже если точные слова запроса не присутствуют в тексте.

### 6.5 Отслеживание стоимости

Система ведет учет использования LLM API:

**Таблица `llm_usage_logs`:**

| Поле | Описание |
|------|----------|
| `model` | Идентификатор модели |
| `prompt_tokens` | Токены промпта |
| `completion_tokens` | Токены ответа |
| `total_tokens` | Всего токенов |
| `estimated_cost_usd` | Оценочная стоимость в USD |
| `task_name` | Название задачи |
| `posts_processed` | Обработано постов |

**Ценообразование Groq (на январь 2026):**

| Модель | Input ($/1M tokens) | Output ($/1M tokens) |
|--------|---------------------|----------------------|
| qwen-qwq-32b | $0.15 | $0.60 |
| llama-3.1-70b-versatile | $0.59 | $0.79 |
| llama-3.1-8b-instant | $0.05 | $0.08 |

**Команда `/llmstats` показывает:**
- Статистика за сегодня (токены, стоимость, посты)
- Статистика за неделю
- Статистика за месяц
- Статус дневного лимита расходов

---

## 7. Доступные данные

### 7.1 Данные, используемые существующими инструментами

| Данные | Используется в |
|--------|----------------|
| `post_content.text_content` | Поиск, отображение результатов |
| `engagement_metrics.*` | Ранжирование, отображение |
| `channel.*` | Управление каналами, информация |
| `post_enrichments.*` | LLM-поиск, фильтрация |
| `llm_usage_logs.*` | Команда /llmstats |
| `saved_topics.*` | Управление топиками |

### 7.2 Данные, хранящиеся но не экспонированные

| Данные | Таблица | Потенциальное использование |
|--------|---------|----------------------------|
| `post_media.*` | `post_media` | Галерея медиа, фильтр по типу |
| `reaction_counts.*` | `reaction_counts` | Детальная аналитика реакций |
| `channel_health_logs.*` | `channel_health_logs` | История здоровья канала |
| `entities` в enrichments | `post_enrichments` | Поиск по персонам/организациям |
| `forward_from_*` | `posts` | Анализ источников контента |
| `language` | `post_content` | Фильтр по языку |

### 7.3 Что легко добавить

| Функция | Сложность | Требуемые изменения |
|---------|-----------|---------------------|
| Фильтр по типу медиа | Низкая | Новый параметр в search |
| Поиск по персонам | Низкая | SQL запрос по entities->persons |
| Статистика реакций по эмодзи | Низкая | Новая команда бота |
| Экспорт с медиа | Средняя | Расширение ExportService |
| Фильтр по языку | Низкая | Параметр language в search |
| Топ каналов по вовлеченности | Низкая | Агрегирующий SQL запрос |

---

## 8. Сценарии использования

### 8.1 Мониторинг новостей по теме

**Шаг 1:** Добавить каналы
```
/addchannel @rian_ru
/addchannel @taborsky
/addchannel @kommersant
```

**Шаг 2:** Настроить режим поиска
```
/mode llm
```

**Шаг 3:** Создать поисковый запрос
```
/search санкции экономика category:economics
```

**Шаг 4:** Сохранить как топик
```
/savetopic sanctions_news
```

**Шаг 5:** Использовать топик ежедневно
```
/topic sanctions_news
/export csv
```

### 8.2 Анализ конкурентов

```
1. /addchannel @competitor1
2. /addchannel @competitor2
3. /search product_name
4. /export json
```

Экспортированные данные содержат метрики вовлеченности для сравнительного анализа.

### 8.3 Мониторинг кризисных ситуаций

```
1. /mode llm
2. /search crisis_keywords sentiment:negative
3. Отслеживать результаты с высоким engagement
4. /export csv для отчетности
```

### 8.4 Исследование рынка

```
1. Добавить релевантные отраслевые каналы
2. /search industry_keywords category:economics
3. Анализировать implicit_keywords для обнаружения трендов
4. Использовать entities для идентификации ключевых игроков
```

### 8.5 Отслеживание упоминаний бренда

```
1. /search "название бренда" OR "название продукта"
2. /savetopic brand_mentions
3. /topic brand_mentions (ежедневно)
4. Анализировать sentiment для оценки репутации
```

---

## 9. Конфигурация

### 9.1 Переменные окружения

#### Основные настройки

| Переменная | Значение по умолчанию | Описание |
|------------|----------------------|----------|
| `APP_ENV` | `development` | Окружение (development/staging/production) |
| `DEBUG` | `true` | Режим отладки |
| `LOG_LEVEL` | `DEBUG` | Уровень логирования |

#### База данных

| Переменная | Значение по умолчанию | Описание |
|------------|----------------------|----------|
| `POSTGRES_HOST` | `localhost` | Хост PostgreSQL |
| `POSTGRES_PORT` | `5432` | Порт PostgreSQL |
| `POSTGRES_DB` | `tnse` | Имя базы данных |
| `POSTGRES_USER` | `tnse_user` | Пользователь |
| `POSTGRES_PASSWORD` | - | Пароль |
| `DATABASE_URL` | - | Полный URL (альтернатива) |

#### Redis

| Переменная | Значение по умолчанию | Описание |
|------------|----------------------|----------|
| `REDIS_HOST` | `localhost` | Хост Redis |
| `REDIS_PORT` | `6379` | Порт Redis |
| `REDIS_URL` | - | Полный URL (альтернатива) |

#### Telegram

| Переменная | Описание |
|------------|----------|
| `TELEGRAM_BOT_TOKEN` | Токен бота от @BotFather |
| `TELEGRAM_API_ID` | API ID от my.telegram.org |
| `TELEGRAM_API_HASH` | API Hash от my.telegram.org |
| `TELEGRAM_PHONE` | Номер телефона для сессии |
| `ALLOWED_TELEGRAM_USERS` | Список разрешенных user ID (через запятую) |
| `BOT_POLLING_MODE` | `true` для polling, `false` для webhook |

#### LLM (Groq)

| Переменная | Значение по умолчанию | Описание |
|------------|----------------------|----------|
| `GROQ_API_KEY` | - | API ключ Groq |
| `GROQ_MODEL` | `qwen-qwq-32b` | Модель |
| `GROQ_ENABLED` | `false` | Включить LLM |
| `GROQ_RATE_LIMIT_RPM` | `30` | Лимит запросов в минуту |
| `GROQ_TIMEOUT_SECONDS` | `30.0` | Таймаут запроса |
| `LLM_DAILY_COST_LIMIT_USD` | `10.00` | Дневной лимит расходов |
| `ENRICHMENT_RATE_LIMIT` | `10` | Лимит обогащения в минуту |

#### Обработка контента

| Переменная | Значение по умолчанию | Описание |
|------------|----------------------|----------|
| `CONTENT_WINDOW_HOURS` | `24` | Временное окно сбора (часы) |
| `COLLECTION_INTERVAL_MINUTES` | `15` | Интервал сбора (минуты) |
| `MAX_CHANNELS_PER_BATCH` | `50` | Максимум каналов за пакет |
| `MAX_SEARCH_RESULTS` | `100` | Максимум результатов поиска |
| `SEARCH_CACHE_TTL` | `300` | TTL кэша поиска (секунды) |

### 9.2 Запуск системы

#### С помощью Docker Compose

```bash
# Запустить PostgreSQL и Redis
make docker-up

# Или с профилями
docker compose up -d postgres redis

# Запустить worker и beat
docker compose --profile worker up -d

# Запустить все
docker compose --profile app --profile worker up -d
```

#### Локально (для разработки)

```bash
# Установка зависимостей
make setup

# Применить миграции
make db-upgrade

# Запустить бота
python -m src.tnse.bot

# В отдельном терминале - Celery worker
celery -A src.tnse.core.celery_app worker --loglevel=info

# В отдельном терминале - Celery beat
celery -A src.tnse.core.celery_app beat --loglevel=info
```

---

## 10. Устранение неполадок

### 10.1 Частые проблемы

#### Бот не отвечает

1. Проверьте `TELEGRAM_BOT_TOKEN`
2. Проверьте доступ пользователя (`ALLOWED_TELEGRAM_USERS`)
3. Проверьте логи: `docker logs tnse_app`

#### Каналы не добавляются

1. Проверьте `TELEGRAM_API_ID` и `TELEGRAM_API_HASH`
2. Проверьте сессию Telethon (`tnse_session.session`)
3. Убедитесь, что канал публичный

#### Контент не собирается

1. Проверьте статус Celery worker: `docker logs tnse_celery_worker`
2. Проверьте Redis: `docker exec tnse_redis redis-cli ping`
3. Проверьте здоровье каналов: `/health`

#### LLM-обогащение не работает

1. Проверьте `GROQ_API_KEY`
2. Проверьте `GROQ_ENABLED=true`
3. Проверьте логи worker на ошибки rate limit
4. Проверьте `/llmstats` на превышение лимитов

### 10.2 Полезные команды

```bash
# Проверить статус контейнеров
docker compose ps

# Просмотреть логи
docker logs -f tnse_celery_worker
docker logs -f tnse_celery_beat

# Проверить Redis
docker exec tnse_redis redis-cli info

# Проверить PostgreSQL
docker exec tnse_postgres psql -U tnse_user -d tnse -c "SELECT count(*) FROM posts;"

# Принудительно запустить задачу сбора
docker exec tnse_celery_worker celery -A src.tnse.core.celery_app call src.tnse.pipeline.tasks.collect_all_channels
```

### 10.3 Логи и мониторинг

Система использует структурированное логирование в формате JSON. Ключевые поля:

| Поле | Описание |
|------|----------|
| `level` | Уровень логирования |
| `message` | Сообщение |
| `timestamp` | Временная метка |
| `channel_id` | ID канала (если применимо) |
| `post_id` | ID поста (если применимо) |
| `user_id` | Telegram user ID |
| `error` | Текст ошибки |

### 10.4 Ограничения

| Ограничение | Значение | Обходной путь |
|-------------|----------|---------------|
| Telegram message limit | 4096 символов | Результаты автоматически обрезаются |
| Groq free tier | 30 RPM | Встроенный rate limiter |
| Session file | Требуется авторизация | Запустить `scripts/auth_telegram.py` |
| Public channels only | - | Приватные каналы не поддерживаются |

---

## Приложение А: Глоссарий

| Термин | Определение |
|--------|-------------|
| **Explicit keywords** | Ключевые слова, непосредственно присутствующие в тексте |
| **Implicit keywords** | Связанные понятия, семантически релевантные но не упомянутые в тексте |
| **Engagement** | Вовлеченность аудитории (просмотры, реакции, репосты) |
| **Relative engagement** | Вовлеченность, нормализованная по числу подписчиков |
| **Reaction score** | Взвешенная оценка реакций на пост |
| **RAG** | Retrieval-Augmented Generation - подход к поиску с использованием LLM |
| **Enrichment** | Обогащение данных поста метаданными через LLM |
| **Topic** | Сохраненная поисковая конфигурация |
| **Template** | Предустановленный шаблон поиска |

---

## Приложение Б: Версионирование

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.0 | Январь 2026 | Первоначальная версия документации |

---

*Документ создан автоматически на основе анализа кодовой базы TNSE.*
