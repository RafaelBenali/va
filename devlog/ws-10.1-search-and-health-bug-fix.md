# WS-10.1: Search and Channel Health Bug Fix

## Date: 2026-01-05

## Summary

Fixed two critical bugs affecting the Telegram bot's core functionality:

1. **Search Bug**: Queries that should match existing content were returning no results
2. **Channel Health Bug**: Channel info showed `health_status=Unknown` and `Last Check: Never` despite content existing in the database

## Root Cause Analysis

### Search Bug

**Problem**: The search service used PostgreSQL's `to_tsquery()` function which requires pre-processed lexemes (stemmed words), but passed raw keywords joined with `&` (e.g., `'hello & world'`).

**Why it failed**:
- `to_tsquery('english', 'hello & world')` expects 'hello' and 'world' to already be valid lexemes
- For many user queries, the raw keywords were not valid tsquery format
- This caused the PostgreSQL full-text search to fail silently and return no results

**File affected**: `src/tnse/search/service.py`

### Channel Health Bug

**Problem**: No health logs were ever created for channels, so `/channelinfo` always showed:
- Health Status: Unknown
- Last Check: Never

**Why it failed**:
1. `addchannel_command` only created a `Channel` record, not a `ChannelHealthLog`
2. `collect_channel_content` task collected content but never logged health status
3. The display code in `/channelinfo` was correct - it just had no data to show

**Files affected**:
- `src/tnse/bot/channel_handlers.py`
- `src/tnse/pipeline/tasks.py`

## Solution

### Search Fix

Changed from `to_tsquery` to `plainto_tsquery` which accepts plain text and handles tokenization internally:

```python
# Before (buggy):
search_terms = " & ".join(query.keywords)
# SQL used: to_tsquery('english', :search_terms)

# After (fixed):
search_terms = " ".join(query.keywords)
# SQL uses: plainto_tsquery('english', :search_terms)
```

The `plainto_tsquery` function:
- Accepts plain text input (no special formatting required)
- Automatically tokenizes and stems the input
- Joins tokens with AND logic
- Works correctly with Russian, English, and mixed-language queries

### Channel Health Fix

1. **In `addchannel_command`**: Added creation of initial `ChannelHealthLog` with `status='healthy'` after successfully adding a channel:

```python
# After session.add(new_channel)
await session.flush()  # Get the channel ID

initial_health_log = ChannelHealthLog(
    channel_id=new_channel.id,
    status=ChannelStatus.HEALTHY.value,
    error_message=None,
)
session.add(initial_health_log)
```

2. **In `collect_channel_content` task**: Added health logging for both successful and failed collections:
- On success: Log `HEALTHY` status
- On rate limit error: Log `RATE_LIMITED` status
- On access error: Log `INACCESSIBLE` status

## Test Coverage

### New Test Files

1. `tests/unit/search/test_search_tsquery_bug.py`:
   - `test_search_with_simple_word_should_match_content`
   - `test_search_query_uses_plainto_tsquery_format`
   - `test_search_with_cyrillic_words_should_work`
   - `test_search_empty_result_when_content_exists`
   - `test_post_content_table_should_have_tsvector_column`
   - `test_migration_should_add_gin_index`

2. `tests/unit/bot/test_channel_health_bug.py`:
   - `test_addchannel_should_create_initial_health_log`
   - `test_collect_channel_content_should_update_health_status`
   - `test_channelinfo_shows_health_status_from_logs`
   - `test_channel_with_health_log_shows_status`
   - `test_channel_without_health_log_shows_unknown`
   - `test_channel_status_enum_has_required_values`

### Updated Test Files

- `tests/integration/test_bot_integration.py`: Added `flush` method to mock session fixture for compatibility with new health logging
- `tests/unit/security/test_security_audit.py`: Updated to accept both `Optional[str]` and `str | None` (PEP 604) syntax

## Files Changed

1. `src/tnse/search/service.py`
   - Changed `to_tsquery` to `plainto_tsquery`
   - Changed keyword joining from `" & "` to `" "`

2. `src/tnse/bot/channel_handlers.py`
   - Added `ChannelHealthLog` and `ChannelStatus` imports
   - Added `await session.flush()` to get channel ID
   - Added initial health log creation after adding channel

3. `src/tnse/pipeline/tasks.py`
   - Added `ChannelHealthLog` and `ChannelStatus` imports
   - Added health logging on collection success
   - Added health logging on collection failure with error categorization

4. `tests/integration/test_bot_integration.py`
   - Added `flush` method to mock session fixture
   - Added async context manager support to mock session

5. `tests/unit/security/test_security_audit.py`
   - Updated assertions to accept PEP 604 type annotation syntax

## Verification

All 73 tests in the search, bot health, and pipeline modules pass:

```
tests/unit/search/test_search_service.py - 18 passed
tests/unit/search/test_search_service_async.py - 5 passed
tests/unit/search/test_search_tsquery_bug.py - 6 passed
tests/unit/search/test_tokenizer.py - 19 passed
tests/unit/bot/test_channel_health_bug.py - 6 passed
tests/unit/pipeline/test_tasks.py - 19 passed
```

## Future Improvements

The search functionality could be further improved by:

1. **Adding a GIN index**: The search currently computes `to_tsvector` on every query. Adding a GIN index on a stored tsvector column would improve performance significantly for large datasets.

2. **Adding a tsvector column**: Store pre-computed search vectors in `post_content` table to avoid runtime computation.

3. **Periodic health checks**: Currently, health is only logged during content collection. A dedicated health check task could verify channel accessibility even when content isn't being collected.

## Conclusion

Both bugs were successfully fixed with TDD methodology:
1. Investigated and understood the root cause
2. Wrote failing tests exposing the bugs
3. Implemented fixes
4. Verified all tests pass

The fixes are minimal and focused, changing only the necessary code to resolve the issues without introducing new complexity.
